<!DOCTYPE html>
<html>

<head>
    <title>BLYNK-Desktop Client</title>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
    <nav>
        <div class="nav-wrapper">
            <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons center">menu</i></a>
            <a id="project-name" class="brand-logo center">Select Project</a>
        </div>
    </nav>

    <ul id="slide-out" class="sidenav">
    </ul>


    <div class="row" id="widgets"></div>

    <!--JavaScript at end of body for optimized loading-->
    <script>
        /* TODO: on Project change dropdown
         * 
         */


        //Project Nav Bar
        const {
            remote
        } = require('electron')

        document.addEventListener('DOMContentLoaded', function() {
            updateMaterialize()
        });

        function updateMaterialize() {
            var elems = document.querySelectorAll('.sidenav');
            var instances = M.Sidenav.init(elems);
            var collapsibleElements = document.querySelectorAll('.collapsible');
            var collapsibleInstances = M.Collapsible.init(collapsibleElements);
            var tabs = document.querySelectorAll('.tabs');
            var tabInstance = M.Tabs.init(tabs)
        }



        const Store = require("electron-store")
        const https = require("https")
        const store = new Store();

        var projects = store.get("projects") || [] //load projects
        var accesses = store.get("accesses") || []

        update()

        function update() {
            updateSideBar()
            updateWidgets()
        }

        //UPDATE if url has changed
        window.addEventListener('hashchange', function() {
            update()
        })

        function updateSideBar() {
            //fill sidebar
            const table = document.querySelector('ul')
            projects = store.get("projects") || [] //load projects
            accesses = store.get("accesses") || []

            table.innerHTML = "";

            //add header
            li = document.createElement("li")
            content = document.createElement("a")
            content.innerHTML = "Projects"
            content.className = "subheader"
            icon = document.createElement("i")
            icon.className = "material-icons left"
            icon.innerHTML = "description"
            content.appendChild(icon)
            li.appendChild(content)
            table.appendChild(li)

            for (let index = 0; index < projects.length; index++) {
                project = projects[index]
                project = JSON.parse(project)
                const li = document.createElement("li")
                const projectLink = document.createElement("a")
                projectLink.href = "#" + index
                projectLink.innerHTML = project.name
                projectLink.id = index
                projectLink.className = "waves-effect"

                li.appendChild(projectLink)
                table.appendChild(li)
            }


            //add Divider
            li = document.createElement("li")
            content = document.createElement("div")
            content.className = "divider"
            li.appendChild(content)
            table.appendChild(li)

            li = document.createElement("li")
            content = document.createElement("a")
            content.innerHTML = "Devices"
            content.className = "subheader"
            icon = document.createElement("i")
            icon.className = "material-icons left"
            icon.innerHTML = "devices"
            content.appendChild(icon)
            li.appendChild(content)
            table.appendChild(li)


            //add Devices of selected Project
            var selectedProjectID = getAnchor()
            project = JSON.parse(projects[selectedProjectID])
            access = JSON.parse(accesses[selectedProjectID])
            document.getElementById("project-name").innerHTML = project.name

            for (let index = 0; index < project.devices.length; index++) {
                const device = project.devices[index]

                //wrapper
                const li = document.createElement("li")
                const ul = document.createElement("ul")
                ul.className = "collapsible collapsible-accordion"
                const li2 = document.createElement("li")
                const deviceLink = document.createElement("a")

                //device name
                deviceLink.innerHTML = device.name

                //dropdown
                deviceLink.className = "collapsible-header waves-effect"
                const icon = document.createElement("i")
                icon.className = "material-icons right"
                icon.innerHTML = "arrow_drop_down"
                deviceLink.appendChild(icon)
                li2.appendChild(deviceLink)
                const div = document.createElement("div")
                div.className = "collapsible-body"
                const dropdownUl = document.createElement("ul")

                //board type
                row = document.createElement("li")
                param = document.createElement("a")
                param.innerHTML = device.boardType
                row.appendChild(param)
                dropdownUl.appendChild(row)

                //board state
                row = document.createElement("li")
                param = document.createElement("a")
                param.innerHTML = "Offline" //checkHardwareConnection(url = access.url, port = access.port, token = device.token)
                row.appendChild(param)
                dropdownUl.appendChild(row)

                //add Token
                row = document.createElement("li")
                var param = document.createElement("a")
                    //param.addEventListener("click", remote.getGlobal("createAddDeviceTokenWindow")(1))
                param.innerHTML = "Add Token"
                    //param.href = "#"
                row.appendChild(param)
                dropdownUl.appendChild(row)


                div.appendChild(dropdownUl)
                li2.appendChild(div)
                ul.appendChild(li2)
                li.appendChild(ul)
                table.appendChild(li)
            }
        }

        function updateWidgets() {
            widgets = require("./widgets.js")
            var dom = document.getElementById("widgets")
            var selectedProjectID = getAnchor()
            project = JSON.parse(projects[selectedProjectID])
            for (let index = 0; index < project.widgets.length; index++) {
                widget = project.widgets[index]
                dom.appendChild(widgets(widget))
            }
        }


        function getAnchor() {
            var currentUrl = document.URL,
                urlParts = currentUrl.split('#')

            return (urlParts.length > 1) ? urlParts[1] : 0
        }

        function checkHardwareConnection(url = "blynk-cloud.com", port = "9443", token) {
            process.env["NODE_TLS_REJECT_UNAUTHORIZED"] = 0; //TODO: make more secure
            https.get("https://" + url + ":" + port + "/" + token + "/isHardwareConnected", (resp) => {
                let data = ""

                resp.on("data", (chunk) => {
                    data += chunk
                })
                resp.on("end", () => {
                    return data
                })
            }).on("error", (err) => {
                console.log("Error: " + err.message)
            })

            process.env["NODE_TLS_REJECT_UNAUTHORIZED"] = 1;
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>

</html>